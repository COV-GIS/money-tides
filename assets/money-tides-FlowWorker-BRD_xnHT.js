import{gy as v,kd as D,ke as _,kf as M,kg as S,kh as E,v as z,y as $}from"./index-CREVO_qW.js";function T(e,a,t){const{extent:r,valid:u}=e,[n,l,s,i]=r;return!(t<l||t>i)&&(u!=null&&n>s?a>=s||a<=n:a>=n&&a<=s)}function b(e,a,t,r){const{extent:u,modelSize:n,valid:l}=e,[s,i,c]=u,f=j(s,c,l);let o=a/n[0]*f+s;return l!=null&&r&&(o=new v(l[0],l[1]).normalize(o)),[o,(n[1]-t)/n[1]*D(u)+i]}function j(e,a,t){if(t!=null&&e>a){const[r,u]=t;return u-e+(a-r)}return a-e}function A(e){return e?4:3}function F(e,a,t){const[r,u]=t.modelSize;let n=null;const l=new Map;a.forEach(i=>{l.set(i.lij,_(e,i))});const s=(i,c,f)=>M(i.extent,c,f);return(i,c)=>{const f=Math.round(i),o=Math.round(c);if(!e.wrapAround&&(f<0||f>=r||o<0||o>=u))return[0,0];const[d,h]=b(t,i,c,!0);if(!T(t,d,h))return[0,0];if(n==null||!s(n,d,h)){n=null;for(const[I,x]of a)if(s(x,d,h)){n=x;break}}if(n?.data==null)return[0,0];const m=l.get(n.lij);if(m==null)return[0,0];const{width:k,height:w,extent:p}=n;return m((d-p[0])/S(p)*k,w-(h-p[1])/D(p)*w)}}let g=class{constructor(){this._tileData=new Map}async generateStreamlines(e){const{flowData:a,flowExtentInfo:t,needsMagnitude:r,simulationSettings:u,startPositions:n}=e,l=y(_(u,a),u,t.modelSize,r,n);return{result:{streamlines:l},transferList:l?.map(s=>s.vertices.buffer)}}async generateTiledStreamlines(e){const{flowDataTiles:a,flowExtentInfo:t,needsMagnitude:r,reset:u,simulationSettings:n,startPositions:l}=e;this._updateTileData(a,u);const s=y(F(n,this._tileData,t),n,t.modelSize,r,l);return{result:{streamlines:s},transferList:s?.map(i=>i.vertices.buffer)??[]}}_updateTileData(e,a){a&&this._tileData.forEach((t,r)=>{e.get(r)==null&&this._tileData.delete(r)}),e.forEach((t,r)=>{t.type==="delete"?this._tileData.delete(r):t.type!=="on-worker"&&t.type!=="waiting"&&this._tileData.set(r,t.data)})}};g=z([$("esri.views.3d.support.flow.FlowWorker")],g);const P=g;function y(e,a,t,r,u){if(e==null)return;const n=E(a,e,t[0],t[1],{positions:u}),l=[],s=A(r);for(const{vertices:i,stage:c}of n){const f=new Float32Array(i.length*s);for(let o=0;o<i.length;o++)f[o*s]=i[o].x,f[o*s+1]=i[o].y,f[o*s+2]=i[o].t,r&&(f[o*s+3]=i[o].speed);l.push({vertices:f,stage:c,hasMagnitude:r})}return l}export{P as default};
