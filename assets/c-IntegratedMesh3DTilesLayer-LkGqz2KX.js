import{f7 as T,R as S,a3 as f,d8 as y,s as p,Z as v,a0 as u,$ as c,b as h,f8 as w,f9 as b,du as L,v as o,x as a,fa as k,bA as I,y as P}from"./index-DwpkWRut.js";import{l as R}from"./c-MultiOriginJSONSupport-xmYaH9Kg.js";import{o as x}from"./c-APIKeyMixin-BWcGo2NF.js";import{l as D}from"./c-ArcGISService-D0SgCHhE.js";import{s as $}from"./c-CustomParametersMixin-BX7Xk1W7.js";import{b as E,m as O,y as j}from"./c-OperationalLayer-B9mQI9WW.js";import{j as q}from"./c-PortalLayer-CyZJkEK9.js";import{t as M}from"./c-ScaleRangeLayer-BMGkvD8D.js";import{n as g}from"./c-SceneModifications-HuV8qO86.js";import{E as N}from"./c-tiles3DUtils-wIf4V37m.js";import{j as m,w as A,R as U}from"./c-elevationInfoUtils-D8SVmt2L.js";import"./c-layerContainerType-CSXZNpHb.js";import"./c-ElevationInfo-CFrN4rhm.js";import"./c-lengthUtils-Bw3cymvn.js";import"./c-portalItemUtils-DyxAsqke.js";let t=class extends D(E(q(M(R($(x(L))))))){readModifications(e,i,s){this._modificationsSource={url:T(e,s),context:s}}initialize(){this.addHandles(S(()=>this.modifications,"after-changes",()=>this.modifications=this.modifications,b))}constructor(e){super(e),this.operationalLayerType="IntegratedMesh3DTilesLayer",this.modifications=null,this._modificationsSource=null,this.spatialReference=new f({wkid:4326,vcsWkid:115700}),this.fullExtent=new y(-180,-90,180,90,this.spatialReference),this.url=null,this.type="integrated-mesh-3dtiles",this.path=null,this.minScale=0,this.maxScale=0,this._rootTilesetJSON=null,this._rootTileset=null,this._key=null,this._session=null,this._rootRequestPromise=null}set elevationInfo(e){e!=null&&e.mode!=="absolute-height"||this._set("elevationInfo",e),this._validateElevationInfo(e)}async load(e){return this.addResolvingPromise(this._doLoad(e)),this}get rootTilesetJSON(){return this._rootTilesetJSON}get rootTileset(){return this._rootTileset}get key(){return this._key}get session(){return this._session}_findSessionParameter(e){const i=[e];for(;i?.length>0;){const s=i.pop();if(!s)return;for(const[n,r]of Object.entries(s)){if(n==="uri")try{const l=new URL("https://tmp"+r).searchParams.get("session");if(l)return l}catch{}typeof r=="object"&&r!==null&&i.push(r)}}return null}async requestRootAndSession(e){const i=(s,n)=>new p("3dtiles-init:"+s,n);return this._rootRequestPromise||(this._rootRequestPromise=new Promise((s,n)=>{this.url||n(i("url-missing","Layer url missing")),this._key=this.customParameters?this.customParameters.key:null,new Promise((r,l)=>{if(this.replacesTerrain&&!this._key){const d=this.portalItem?.portal||this.parent?.portalItem?.portal||v.getDefault();d.signIn().then(()=>{d.g3dTilesEnabled?u(d.restUrl+"/portals/self/modules/g3dtiles",{responseType:"json",query:{f:"json"}}).then(_=>{this._key=_.data.keyString,r()},()=>l(i("g3dtiles-key-error","Error fetching Google 3D Tiles key from portal"))):l(i("g3dTilesEnabled-false","Google 3D Tiles are not enabled on Portal "+d.url))},()=>l(i("sign-in-failed","Error signing in to Portal")))}else r()}).then(()=>{u(this.url,{query:this._key?{key:this._key,token:this.apiKey}:{token:this.apiKey},responseType:"array-buffer",signal:e}).then(r=>{try{this._rootTilesetJSON=JSON.parse(new TextDecoder().decode(r.data))}catch(l){return void n(i("root-parse-failed","Error parsing root tile, details: "+l))}this._rootTilesetJSON?(this._session=this._findSessionParameter(this._rootTilesetJSON),this._rootTileset=r.data,this.fullExtent=N(this._rootTilesetJSON),s(),this._rootRequestPromise=null):n(i("root-is-null","Root tile is null."))},r=>{c(r),n(i("root-load-failed","Error loading root tile")),this._rootRequestPromise=null,h.getLogger("IntegratedMesh3DTilesLayer").error("Layer loading failed",r)})},r=>n(r))})),this._rootRequestPromise}async _doLoad(e){const i=e!=null?e.signal:null;if(this._isUsedAsGroundLayer)throw new p("3dtiles-init:not-supported-in-groundlayers","Layer is not supported in basemap.");try{await this.loadFromPortal({supportedTypes:["3DTiles Service"],validateItem:s=>{if(s.typeKeywords?.includes("IntegratedMesh"))return!0;throw new p("portal:invalid-layer-item-type","Invalid layer item, expected '${expectedType}' ",{expectedType:"3DTiles Service containing IntegratedMesh"})}},e)}catch(s){c(s)}if(this._modificationsSource!=null){const s=await g.fromUrl(this._modificationsSource.url,this.spatialReference,e);this.setAtOrigin("modifications",s,this._modificationsSource.context.origin),this._modificationsSource=null}await this.requestRootAndSession(i)}beforeSave(){if(this._modificationsSource!=null)return this.load().then(()=>{},()=>{})}get hasAttributionData(){return!1}async fetchAttributionData(){return{}}_validateElevationInfo(e){const i="Integrated mesh 3d tiles layers";m(h.getLogger(this),A(i,"absolute-height",e)),m(h.getLogger(this),U(i,e))}get replacesTerrain(){return!1}get _isUsedAsGroundLayer(){return w(this.parent)}get hasGoogleUrl(){return!!this.url?.match(/.+\.googleapis.com/)}};o([a({type:["IntegratedMesh3DTilesLayer"]})],t.prototype,"operationalLayerType",void 0),o([a({type:g,clonable:e=>e.clone()}),k({origins:["web-scene","portal-item"],type:"resource",prefix:"modifications"})],t.prototype,"modifications",void 0),o([I(["web-scene","portal-item"],"modifications")],t.prototype,"readModifications",null),o([a({type:f})],t.prototype,"spatialReference",void 0),o([a({type:y})],t.prototype,"fullExtent",void 0),o([a(O)],t.prototype,"elevationInfo",null),o([a({type:["show","hide"]})],t.prototype,"listMode",void 0),o([a(j)],t.prototype,"url",void 0),o([a({readOnly:!0})],t.prototype,"type",void 0),o([a({type:String,json:{origins:{"web-scene":{read:!0,write:!0},"portal-item":{read:!0,write:!0}},read:!1}})],t.prototype,"path",void 0),o([a({type:Number,json:{name:"layerDefinition.minScale",write:!0,origins:{service:{read:!1,write:!1}}}})],t.prototype,"minScale",void 0),o([a({type:Number,json:{name:"layerDefinition.maxScale",write:!0,origins:{service:{read:!1,write:!1}}}})],t.prototype,"maxScale",void 0),o([a()],t.prototype,"replacesTerrain",null),o([a()],t.prototype,"_isUsedAsGroundLayer",null),o([a()],t.prototype,"hasGoogleUrl",null),t=o([P("esri.layers.IntegratedMesh3DTilesLayer")],t);const te=t;export{te as default};
