import{e as gt}from"./money-tides-deduplicate-1-UOPSgg.js";import{Q as L,t as G}from"./money-tides-InterleavedLayout-DKf8U2JB.js";import{t as it}from"./money-tides-VertexAttributeLocations-BfZbt_DV.js";import{g as wt}from"./money-tides-config-Dy31BTur.js";import{n as N,dn as vt,dj as P,a9 as Z,L as K,co as tt,U as at,V as ct,dr as $t,dq as xt,ab as lt,ct as At}from"./money-tides-app-config-Bx6spTVY.js";import{e as Q}from"./money-tides-Normals-BeA6iEeM.js";import{a3 as J}from"./money-tides-jsxFactory-Du3Z5Qoq.js";const Nt=L().vec3f("position").u16("componentIndex").freeze(),yt=L().vec2u8("sideness").freeze(),ft=G(yt),ut=L().vec3f("position0").vec3f("position1").vec2i16("normalCompressed").u16("componentIndex").u8("variantOffset",{glNormalized:!0}).u8("variantStroke").u8("variantExtension",{glNormalized:!0}).freeze(),pt=L().vec3f("position0").vec3f("position1").vec2i16("normalCompressed").vec2i16("normal2Compressed").u16("componentIndex").u8("variantOffset",{glNormalized:!0}).u8("variantStroke").u8("variantExtension",{glNormalized:!0}).freeze(),It=G(ut,1),St=G(pt,1);it([ft,It]);it([ft,St]);class Vt{constructor(){this.position0=N(),this.position1=N(),this.faceNormal0=N(),this.faceNormal1=N(),this.componentIndex=0,this.cosAngle=0}}const O=-1;function bt(t,n,o){const r=t.vertices.position,a=t.vertices.componentIndex,f=g.position0,d=g.position1,m=g.faceNormal0,$=g.faceNormal1,{edges:i,normals:u}=Mt(t),w=i.length/4,x=n.allocate(w);let B=0;const k=w,y=o?.allocate(k);let E=0,e=0,s=0;W.length=0;for(let p=0;p<w;++p){const S=4*p;r.getVec(i.data[S],f),r.getVec(i.data[S+1],d);const M=W.pushNew();M.index=4*p,M.length=vt(f,d)}W.sort((p,S)=>S.length-p.length);const l=new Array,c=new Array;W.forAll(({length:p,index:S})=>{const M=i.data[S],ht=i.data[S+1],T=i.data[S+2],X=i.data[S+3],Y=X===O;if(r.getVec(M,f),r.getVec(ht,d),Y){const A=3*T;P(m,u.data[A],u.data[A+1],u.data[A+2]),Z($,m),g.componentIndex=a.get(M),g.cosAngle=K(m,$)}else{let A=3*T;if(P(m,u.data[A],u.data[A+1],u.data[A+2]),A=3*X,P($,u.data[A],u.data[A+1],u.data[A+2]),g.componentIndex=a.get(M),g.cosAngle=K(m,$),Bt(g,Ft))return;g.cosAngle<-.9999&&Z($,m)}e+=p,s++,Y||zt(g,kt)?(n.write(x,B++,g),l.push(p)):_t(g,dt)&&(y&&o&&o.write(y,E++,g),c.push(p))});const v=new Float32Array(l.reverse()),I=new Float32Array(c.reverse()),V=y&&o?{instancesData:y.slice(0,E),lodInfo:{lengths:I}}:void 0;return{regular:{instancesData:x.slice(0,B),lodInfo:{lengths:v}},silhouette:V,averageEdgeLength:e/s}}function zt(t,n){return t.cosAngle<n}function Bt(t,n){return t.cosAngle>n}function _t(t,n){const o=$t(t.cosAngle);return xt(et,t.position1,t.position0),o*(K(at(Ct,t.faceNormal0,t.faceNormal1),et)>0?-1:1)>n}function Mt(t){const n=t.faces.length/3,o=t.faces,r=t.neighbors,a=t.vertices.position;h.length=H.length=0;for(let f=0;f<n;f++){const d=3*f,m=r[d],$=r[d+1],i=r[d+2],u=o[d],w=o[d+1],x=o[d+2];a.getVec(u,_),a.getVec(w,D),a.getVec(x,q),tt(D,D,_),tt(q,q,_),at(_,D,q),ct(_,_),H.pushArray(_),(m===O||u<w)&&(h.push(u),h.push(w),h.push(f),h.push(m)),($===O||w<x)&&(h.push(w),h.push(x),h.push(f),h.push($)),(i===O||x<u)&&(h.push(x),h.push(u),h.push(f),h.push(i))}return{edges:h,normals:H}}class Ut{constructor(){this.index=0,this.length=0}}const W=new J({allocator:t=>t||new Ut,deallocator:null}),h=new J({deallocator:null}),H=new J({deallocator:null}),g=new Vt,Ct=N(),et=N(),_=N(),D=N(),q=N(),dt=lt(4),Ft=Math.cos(dt),Lt=lt(35),kt=Math.cos(Lt);function nt(t,n,o){const r=n/3,a=new Uint32Array(o+1),f=new Uint32Array(o+1),d=(e,s)=>{e<s?a[e+1]++:f[s+1]++};for(let e=0;e<r;e++){const s=t[3*e],l=t[3*e+1],c=t[3*e+2];d(s,l),d(l,c),d(c,s)}let m=0,$=0;for(let e=0;e<o;e++){const s=a[e+1],l=f[e+1];a[e+1]=m,f[e+1]=$,m+=s,$+=l}const i=new Uint32Array(6*r),u=a[o],w=(e,s,l)=>{if(e<s){const c=a[e+1]++;i[2*c]=s,i[2*c+1]=l}else{const c=f[s+1]++;i[2*u+2*c]=e,i[2*u+2*c+1]=l}};for(let e=0;e<r;e++){const s=t[3*e],l=t[3*e+1],c=t[3*e+2];w(s,l,e),w(l,c,e),w(c,s,e)}const x=(e,s)=>{const l=2*e,c=s-e;for(let v=1;v<c;v++){const I=i[l+2*v],V=i[l+2*v+1];let p=v-1;for(;p>=0&&i[l+2*p]>I;p--)i[l+2*p+2]=i[l+2*p],i[l+2*p+3]=i[l+2*p+1];i[l+2*p+2]=I,i[l+2*p+3]=V}};for(let e=0;e<o;e++)x(a[e],a[e+1]),x(u+f[e],u+f[e+1]);const B=new Int32Array(3*r),k=(e,s)=>e===t[3*s]?0:e===t[3*s+1]?1:e===t[3*s+2]?2:-1,y=(e,s)=>{const l=k(e,s);B[3*s+l]=-1},E=(e,s,l,c)=>{const v=k(e,s);B[3*s+v]=c;const I=k(l,c);B[3*c+I]=s};for(let e=0;e<o;e++){let s=a[e];const l=a[e+1];let c=f[e];const v=f[e+1];for(;s<l&&c<v;){const I=i[2*s],V=i[2*u+2*c];I===V?(E(e,i[2*s+1],V,i[2*u+2*c+1]),s++,c++):I<V?(y(e,i[2*s+1]),s++):(y(V,i[2*u+2*c+1]),c++)}for(;s<l;)y(e,i[2*s+1]),s++;for(;c<v;)y(i[2*u+2*c],i[2*u+2*c+1]),c++}return B}const R=.7;let mt=class{updateSettings(n){this.settings=n,this._edgeHashFunction=n.reducedPrecision?Wt:Et}write(n,o,r){j.seed=this._edgeHashFunction(r);const a=j.getIntRange(0,255),f=j.getIntRange(0,this.settings.variants-1),d=j.getFloat(),m=255*(.5*Dt(-(1-Math.min(d/R,1))+Math.max(0,d-R)/(1-R),1.2)+.5);n.position0.setVec(o,r.position0),n.position1.setVec(o,r.position1),n.componentIndex.set(o,r.componentIndex),n.variantOffset.set(o,a),n.variantStroke.set(o,f),n.variantExtension.set(o,m)}};const b=new Float32Array(6),z=new Uint32Array(b.buffer),F=new Uint32Array(1);function Et(t){return b[0]=t.position0[0],b[1]=t.position0[1],b[2]=t.position0[2],b[3]=t.position1[0],b[4]=t.position1[1],b[5]=t.position1[2],F[0]=31*(31*(31*(31*(31*(166811+z[0])+z[1])+z[2])+z[3])+z[4])+z[5],F[0]}function Wt(t){const n=b;n[0]=U(t.position0[0]),n[1]=U(t.position0[1]),n[2]=U(t.position0[2]),n[3]=U(t.position1[0]),n[4]=U(t.position1[1]),n[5]=U(t.position1[2]),F[0]=5381;for(let o=0;o<z.length;o++)F[0]=31*F[0]+z[o];return F[0]}const ot=1e4;function U(t){return Math.round(t*ot)/ot}function Dt(t,n){return Math.abs(t)**n*Math.sign(t)}class qt{constructor(){this._commonWriter=new mt}updateSettings(n){this._commonWriter.updateSettings(n)}allocate(n){return ut.createBuffer(n)}write(n,o,r){this._commonWriter.write(n,o,r),At(C,r.faceNormal0,r.faceNormal1),ct(C,C);const{typedBuffer:a,typedBufferStride:f}=n.normalCompressed;Q(a,o,C[0],C[1],C[2],f)}}class jt{constructor(){this._commonWriter=new mt}updateSettings(n){this._commonWriter.updateSettings(n)}allocate(n){return pt.createBuffer(n)}write(n,o,r){this._commonWriter.write(n,o,r);{const{typedBuffer:a,typedBufferStride:f}=n.normalCompressed;Q(a,o,r.faceNormal0[0],r.faceNormal0[1],r.faceNormal0[2],f)}{const{typedBuffer:a,typedBufferStride:f}=n.normal2Compressed;Q(a,o,r.faceNormal1[0],r.faceNormal1[1],r.faceNormal1[2],f)}}}const C=N(),j=new wt;function Yt(t){const n=Ot(t.data,t.skipDeduplicate,t.indices,t.indicesLength);return st.updateSettings(t.writerSettings),rt.updateSettings(t.writerSettings),bt(n,st,rt)}function Ot(t,n,o,r){if(n){const d=nt(o,r,t.count);return new Pt(o,r,d,t)}const a=gt(t.buffer,t.stride/4,{originalIndices:o}),f=nt(a.indices,r,a.uniqueCount);return{faces:a.indices,facesLength:a.indices.length,neighbors:f,vertices:Nt.createView(a.buffer)}}class Pt{constructor(n,o,r,a){this.faces=n,this.facesLength=o,this.neighbors=r,this.vertices=a}}const st=new qt,rt=new jt,Zt=L().vec3f("position0").vec3f("position1"),te=L().vec3f("position0").vec3f("position1").u16("componentIndex");export{Zt as a,Yt as c,bt as d,Ot as f,te as g,Nt as t};
