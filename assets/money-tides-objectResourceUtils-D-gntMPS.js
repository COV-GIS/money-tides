const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/money-tides-loader-Cd3SL3p-.js","assets/money-tides-jsxFactory-Citpbvhe.js","assets/index-COoOQZh6.js","assets/index-BU23byjB.css","assets/money-tides-runtime-BAFbAsol.js","assets/runtime-OCMtRbrJ.css","assets/money-tides-app-config-DXx2__X3.js","assets/money-tides-ReactiveMap-B6WeoYy4.js","assets/money-tides-messageBundle-DK3KoGCk.js","assets/money-tides-index-BSQMl5Dg.js","assets/money-tides-quat-BJaibM4r.js","assets/money-tides-quatf64-aQ5IuZRd.js","assets/money-tides-BufferView-DfQkuz17.js","assets/money-tides-resourceUtils-DIO6z-yA.js"])))=>i.map(i=>d[i]);
import{_ as ce}from"./index-COoOQZh6.js";import{is as fe,it as me,h2 as V,ac as Y,gB as H,f3 as de,iu as Z,m as z,hv as ee,f4 as te,ii as j,x as pe,v as he,j as q,dk as W,co as xe,iv as J,cp as ge,a3 as ye,df as be,cJ as Te,iw as G,ix as we,fD as ve,fE as K,fF as $e}from"./money-tides-app-config-DXx2__X3.js";import{a as Me}from"./money-tides-devEnvironmentUtils-8WtPGj6h.js";import{m as re,n as F}from"./money-tides-OutputColorHighlightOID.glsl-Dvf1vhg_.js";import{o as se,T as oe,g as Ae,M as Re,O as Be,V as Se}from"./money-tides-BufferView-DfQkuz17.js";import{r as Pe,n as Ee,d as N,l as Q}from"./money-tides-vec3-j5mnkvQI.js";import{o as Ie,d as X}from"./money-tides-vec4-Dub09r0Y.js";import{l as Oe,o as _e,n as Ce}from"./money-tides-indexUtils-DhBxl13d.js";import{t as U}from"./money-tides-resourceUtils-DIO6z-yA.js";import{H as Fe,j as ne,i as Ue,s as je}from"./money-tides-jsxFactory-Citpbvhe.js";import{t as ke}from"./money-tides-NestedMap-B93H1Ttm.js";import{A as Le}from"./money-tides-Indices-DRGCIkB9.js";import{t as De}from"./money-tides-requestImageUtils-Cq0SnhhK.js";import{t as I}from"./money-tides-orientedBoundingBox-Dv7ndcrm.js";import{M as ae}from"./money-tides-Texture-WzIcL1cS.js";import{P as k,n as Ve,o as qe,s as Ge,t as He}from"./money-tides-DefaultMaterial-yzjdey87.js";function _(r){if(r==null)return null;const t=r.offset!=null?r.offset:fe,o=r.rotation!=null?r.rotation:0,s=r.scale!=null?r.scale:me,l=V(1,0,0,0,1,0,t[0],t[1],1),i=V(Math.cos(o),-Math.sin(o),0,Math.sin(o),Math.cos(o),0,0,0,1),n=V(s[0],0,0,0,s[1],0,0,0,1),a=Y();return H(a,i,n),H(a,l,a),a}class ze{constructor(){this.geometries=new Array,this.materials=new Array,this.textures=new Array}}class We{constructor(t,o,s){this.name=t,this.lodThreshold=o,this.pivotOffset=s,this.stageResources=new ze,this.numberOfVertices=0}}const R=()=>Ue.getLogger("esri.views.3d.layers.graphics.objectResourceUtils");class Je{constructor(t,o,s){this.resource=t,this.textures=o,this.usedMemory=s}}async function Ke(r,t){const o=await Ne(r,t),s=await et(o.textureDefinitions??{},t);let l=0;for(const i in s)if(s.hasOwnProperty(i)){const n=s[i];l+=n?.image?n.image.width*n.image.height*4:0}return new Je(o,s,l+de(o))}async function Ne(r,t){const o=t?.streamDataRequester;if(o)return Qe(r,o,t);const s=await ee(Fe(r,t));if(s.ok===!0)return s.value.data;ne(s.error),ie(s.error)}async function Qe(r,t,o){const s=await ee(t.request(r,0,o));if(s.ok===!0)return s.value;ne(s.error),ie(s.error.details.url)}function ie(r){throw new je("",`Request for object resource failed: ${r}`)}function Xe(r){const t=r.params,o=t.topology;let s=!0;switch(t.vertexAttributes||(R().warn("Geometry must specify vertex attributes"),s=!1),t.topology){case"PerAttributeArray":break;case"Indexed":case null:case void 0:{const i=t.faces;if(i){if(t.vertexAttributes)for(const n in t.vertexAttributes){const a=i[n];a?.values?(a.valueType!=null&&a.valueType!=="UInt32"&&(R().warn(`Unsupported indexed geometry indices type '${a.valueType}', only UInt32 is currently supported`),s=!1),a.valuesPerElement!=null&&a.valuesPerElement!==1&&(R().warn(`Unsupported indexed geometry values per element '${a.valuesPerElement}', only 1 is currently supported`),s=!1)):(R().warn(`Indexed geometry does not specify face indices for '${n}' attribute`),s=!1)}}else R().warn("Indexed geometries must specify faces"),s=!1;break}default:R().warn(`Unsupported topology '${o}'`),s=!1}r.params.material||(R().warn("Geometry requires material"),s=!1);const l=r.params.vertexAttributes;for(const i in l)l[i].values||(R().warn("Geometries with externally defined attributes are not yet supported"),s=!1);return s}function Ye(r,t){const o=new Array,s=new Array,l=new Array,i=new ke,n=r.resource,a=Z.parse(n.version||"1.0","wosr");rt.validate(a);const f=n.model.name,e=n.model.geometries,u=n.materialDefinitions??{},c=r.textures;let x=0;const d=new Map;for(let g=0;g<e.length;g++){const m=e[g];if(!Xe(m))continue;const w=tt(m),b=m.params.vertexAttributes,v=[],y=p=>{if(m.params.topology==="PerAttributeArray")return null;const T=m.params.faces;for(const h in T)if(h===p)return T[h].values;return null},$=b.position,C=$.values.length/$.valuesPerElement;for(const p in b){const T=b[p],h=T.values,D=y(p)??Le(C);v.push([p,new I(h,D,T.valuesPerElement,!0)])}const M=w.texture,B=c&&c[M];if(B&&!d.has(M)){const{image:p,parameters:T}=B,h=new ae(p,T);s.push(h),d.set(M,h)}const O=d.get(M),S=O?O.id:void 0,P=w.material;let A=i.get(P,M);if(A==null){const p=u[P.slice(P.lastIndexOf("/")+1)].params;p.transparency===1&&(p.transparency=0);const T=B?ue(B.alphaChannelUsage):void 0,h={ambient:z(p.diffuse),diffuse:z(p.diffuse),opacity:1-(p.transparency||0),textureAlphaMode:T,textureAlphaCutoff:.33,textureId:S,doubleSided:!0,cullFace:0,colorMixMode:p.externalColorMixMode||"tint",textureAlphaPremultiplied:B?.parameters.preMultiplyAlpha??!1};t?.materialParameters&&Object.assign(h,t.materialParameters),A=new k(h,t),i.set(P,M,A)}l.push(A);const L=new re(A,v);x+=v.find(p=>p[0]==="position")?.[1]?.indices.length??0,o.push(L)}return{engineResources:[{name:f,stageResources:{textures:s,materials:l,geometries:o},pivotOffset:n.model.pivotOffset,numberOfVertices:x,lodThreshold:null}],referenceBoundingBox:Ze(o)}}function Ze(r){const t=te();return r.forEach(o=>{const s=o.boundingInfo;s!=null&&(j(t,s.bbMin),j(t,s.bbMax))}),t}async function et(r,t){const o=new Array;for(const i in r){const n=r[i],a=n.images[0].data;if(!a){R().warn("Externally referenced texture data is not yet supported");continue}const f=n.encoding+";base64,"+a,e="/textureDefinitions/"+i,u=n.channels==="rgba"?n.alphaChannelUsage||"transparency":"none",c={noUnpackFlip:!0,wrap:{s:10497,t:10497},preMultiplyAlpha:ue(u)!==1},x=t?.disableTextures?Promise.resolve(null):De(f,t);o.push(x.then(d=>({refId:e,image:d,parameters:c,alphaChannelUsage:u})))}const s=await Promise.all(o),l={};for(const i of s)l[i.refId]=i;return l}function ue(r){switch(r){case"mask":return 2;case"maskAndTransparency":return 3;case"none":return 1;default:return 0}}function tt(r){const t=r.params;return{id:1,material:t.material,texture:t.texture,region:t.texture}}const rt=new Z(1,2,"wosr");async function st(r,t){const o=le(Me(r));if(o.fileType==="wosr"){const c=await(t.cache?t.cache.loadWOSR(o.url,t):Ke(o.url,t)),{engineResources:x,referenceBoundingBox:d}=Ye(c,t);return{lods:x,referenceBoundingBox:d,isEsriSymbolResource:!1,isWosr:!0}}let s;if(t.cache)s=await t.cache.loadGLTF(o.url,t,!!t.usePBR);else{const{loadGLTF:c}=await ce(()=>import("./money-tides-loader-Cd3SL3p-.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13]));s=await c(new Oe(t.streamDataRequester),o.url,t,t.usePBR)}const l=s.model.meta?.ESRI_proxyEllipsoid,i=s.meta.isEsriSymbolResource&&l!=null&&s.meta.ESRI_webstyle==="EsriRealisticTreesStyle";i&&!s.customMeta.esriTreeRendering&&(s.customMeta.esriTreeRendering=!0,ut(s,l));const n=!!t.usePBR,a=s.meta.isEsriSymbolResource?{usePBR:n,isSchematic:!1,treeRendering:i,mrrFactors:Ge}:{usePBR:n,isSchematic:!1,treeRendering:!1,mrrFactors:He},f={...t.materialParameters,treeRendering:i},{engineResources:e,referenceBoundingBox:u}=ot(s,a,f,t,o.specifiedLodIndex,i);return{lods:e,referenceBoundingBox:u,isEsriSymbolResource:s.meta.isEsriSymbolResource,isWosr:!1}}function le(r){const t=r.match(/(.*\.(gltf|glb))(\?lod=([0-9]+))?$/);return t?{fileType:"gltf",url:t[1],specifiedLodIndex:t[4]!=null?Number(t[4]):null}:r.match(/(.*\.(json|json\.gz))$/)?{fileType:"wosr",url:r,specifiedLodIndex:null}:{fileType:"unknown",url:r,specifiedLodIndex:null}}function ot(r,t,o,s,l,i){const n=r.model,a=new Array,f=new Map,e=new Map,u=n.lods.length,c=te();return n.lods.forEach((x,d)=>{const g=s.skipHighLods===!0&&(u>1&&d===0||u>3&&d===1)||s.skipHighLods===!1&&l!=null&&d!==l;if(g&&d!==0)return;const m=new We(x.name,x.lodThreshold,[0,0,0]);x.parts.forEach(w=>{const b=g?new k({},s):nt(n,w,m,t,o,f,e,s,i),{geometry:v,vertexCount:y}=at(w,b??new k({},s)),$=v.boundingInfo;$!=null&&d===0&&(j(c,$.bbMin),j(c,$.bbMax)),b!=null&&(m.stageResources.geometries.push(v),m.numberOfVertices+=y)}),g||a.push(m)}),{engineResources:a,referenceBoundingBox:c}}function nt(r,t,o,s,l,i,n,a,f){const e=r.materials.get(t.material);if(e==null)return null;const{normal:u,color:c,texCoord0:x,tangent:d}=t.attributes,g=t.material+(u?"_normal":"")+(c?"_color":"")+(x?"_texCoord0":"")+(d?"_tangent":""),m=t.attributes.texCoord0!=null,w=t.attributes.normal!=null,b=it(e.alphaMode);if(!i.has(g)){if(m){const S=(A,L=!1,p=!1)=>{if(A!=null&&!n.has(A)){const T=r.textures.get(A);if(T){const h=T.data,D=L&&!U(h)?a.compressionOptions:void 0;n.set(A,new ae(U(h)?h.data:h,{...T.parameters,preMultiplyAlpha:!U(h)&&p,encoding:U(h)?h.encoding:void 0,compressionOptions:D}))}}},P=b!==1&&!f;S(e.colorTexture,P,b!==1),S(e.normalTexture),S(e.occlusionTexture,!0),S(e.emissiveTexture),S(e.metallicRoughnessTexture,!0)}const y=G(e.color[0]),$=G(e.color[1]),C=G(e.color[2]),M=e.colorTexture!=null&&m?n.get(e.colorTexture):null,B=Ve(e),O=e.normalTextureTransform?.scale!=null?e.normalTextureTransform?.scale:we;i.set(g,new k({...s,customDepthTest:1,textureAlphaMode:b,textureAlphaCutoff:e.alphaCutoff,diffuse:[y,$,C],ambient:[y,$,C],opacity:e.alphaMode==="OPAQUE"?1:e.opacity,doubleSided:e.doubleSided,doubleSidedType:"winding-order",cullFace:e.doubleSided?0:2,hasVertexColors:!!t.attributes.color,hasVertexTangents:!!t.attributes.tangent,normalType:w?0:2,castShadows:!0,receiveShadows:e.receiveShadows,receiveAmbientOcclusion:e.receiveAmbientOcclusion,textureId:M?.id,colorMixMode:e.colorMixMode,normalTextureId:e.normalTexture!=null&&m?n.get(e.normalTexture).id:void 0,textureAlphaPremultiplied:M!=null&&!!M.parameters.preMultiplyAlpha,occlusionTextureId:e.occlusionTexture!=null&&m?n.get(e.occlusionTexture).id:void 0,emissiveTextureId:e.emissiveTexture!=null&&m?n.get(e.emissiveTexture).id:void 0,metallicRoughnessTextureId:e.metallicRoughnessTexture!=null&&m?n.get(e.metallicRoughnessTexture).id:void 0,emissiveBaseColor:[e.emissiveFactor[0],e.emissiveFactor[1],e.emissiveFactor[2]],mrrFactors:B?qe:[e.metallicFactor,e.roughnessFactor,s.mrrFactors[2]],isSchematic:B,colorTextureTransformMatrix:_(e.colorTextureTransform),normalTextureTransformMatrix:_(e.normalTextureTransform),scale:[O[0],O[1]],occlusionTextureTransformMatrix:_(e.occlusionTextureTransform),emissiveTextureTransformMatrix:_(e.emissiveTextureTransform),metallicRoughnessTextureTransformMatrix:_(e.metallicRoughnessTextureTransform),...l},a))}const v=i.get(g);if(o.stageResources.materials.push(v),m){const y=$=>{$!=null&&o.stageResources.textures.push(n.get($))};y(e.colorTexture),y(e.normalTexture),y(e.occlusionTexture),y(e.emissiveTexture),y(e.metallicRoughnessTexture)}return v}function at(r,t){const o=r.attributes.position.count,s=_e(r.indices||o,r.primitiveType),l=F(3*o),{typedBuffer:i,typedBufferStride:n}=r.attributes.position;Pe(l,i,r.transform,3,n);const a=[["position",new I(l,s,3,!0)]];if(r.attributes.normal!=null){const e=F(3*o),{typedBuffer:u,typedBufferStride:c}=r.attributes.normal;ve(E,r.transform),Ee(e,u,E,3,c),K(E)&&N(e,e),a.push(["normal",new I(e,s,3,!0)])}if(r.attributes.tangent!=null){const e=F(4*o),{typedBuffer:u,typedBufferStride:c}=r.attributes.tangent;$e(E,r.transform),Ie(e,u,E,4,c),K(E)&&N(e,e,4),a.push(["tangent",new I(e,s,4,!0)])}if(r.attributes.texCoord0!=null){const e=F(2*o),{typedBuffer:u,typedBufferStride:c}=r.attributes.texCoord0;Ce(e,u,2,c),a.push(["uv0",new I(e,s,2,!0)])}const f=r.attributes.color;if(f!=null){const e=new Uint8Array(4*o);f.elementCount===4?f instanceof oe?X(e,f,1,255):(f instanceof Ae||f instanceof Re)&&X(e,f,1/255,255):(e.fill(255),f instanceof se?Q(e,f.typedBuffer,1,255,4,f.typedBufferStride):(r.attributes.color instanceof Be||r.attributes.color instanceof Se)&&Q(e,f.typedBuffer,1/255,255,4,r.attributes.color.typedBufferStride)),a.push(["color",new I(e,s,4,!0)])}return{geometry:new re(t,a),vertexCount:o}}const E=Y();function it(r){switch(r){case"BLEND":return 0;case"MASK":return 2;case"OPAQUE":case null:case void 0:return 1}}function ut(r,t){for(let o=0;o<r.model.lods.length;++o){const s=r.model.lods[o];for(const l of s.parts){const i=l.attributes.normal;if(i==null)return;const n=l.attributes.position,a=n.count,f=q(),e=q(),u=q(),c=new Float32Array(4*a),x=new Float32Array(3*a),d=pe(he(),l.transform);let g=0,m=0;for(let w=0;w<a;w++){n.getVec(w,e),i.getVec(w,f),W(e,e,l.transform),xe(u,e,t.center),J(u,u,t.radius);const b=u[2],v=ge(u),y=Math.min(.45+.55*v*v,1)**Te;J(u,u,t.radius),d!==null&&W(u,u,d),ye(u,u),o+1!==r.model.lods.length&&r.model.lods.length>1&&be(u,u,f,b>-1?.2:Math.min(-4*b-3.8,1)),x[g]=u[0],x[g+1]=u[1],x[g+2]=u[2],g+=3,c[m]=y,c[m+1]=y,c[m+2]=y,c[m+3]=1,m+=4}l.attributes.normal=new se(x.buffer),l.attributes.color=new oe(c.buffer)}}}const At=Object.freeze(Object.defineProperty({__proto__:null,fetch:st,parseUrl:le},Symbol.toStringTag,{value:"Module"}));export{At as o,_ as s,st as z};
